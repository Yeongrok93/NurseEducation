<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delirium Visual Simulation</title>

<style>

/* ------------------ ë°°ê²½ ------------------ */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    overflow: hidden;

    background: url("/static/image/background.png") no-repeat center center fixed;
    background-size: cover;
}

/* ë°°ê²½ ì–´ë‘¡ê²Œ ì˜¤ë²„ë ˆì´ */
body::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.25);
    z-index: 0;
}

/* ------------------ ìƒíƒœ íŒ¨ë„ ------------------ */
#statusPanel {
    position: absolute;
    top: 2vh;
    left: 2vw;

    width: 22vw;
    min-width: 200px;
    max-width: 300px;

    padding: 1.2vw;

    background: rgba(20, 20, 20, 0.65);
    backdrop-filter: blur(8px);

    border-radius: 14px;
    color: white;

    z-index: 10;
}

#statusPanel h4 {
    font-size: 0.9vw;
    min-font-size: 14px;
}

.bar {
    height: 0.8vh;
    min-height: 8px;
}
/* ------------------ í™˜ì ì˜ì—­ ------------------ */

#groundShadow {
    position: absolute;
    bottom: 160px;
    left: 50%;
    transform: translateX(-50%);
    width: 600px;
    height: 130px;

    background: radial-gradient(ellipse at center,
                rgba(0,0,0,0.5) 0%,
                rgba(0,0,0,0.3) 40%,
                rgba(0,0,0,0) 80%);
    z-index: 1;
}

#patientImage {
    position: absolute;
    bottom: 200px;
    left: 50%;
    transform: translateX(-50%);

    height: 460px;
    z-index: 2;

    filter: drop-shadow(0 20px 40px rgba(0,0,0,0.7));
}

/* ------------------ ëŒ€í™” ë°•ìŠ¤ ------------------ */

#dialogueBox {
    position: fixed;
    bottom: 6vh;
    left: 50%;
    transform: translateX(-50%);
    max-height: 40vh;      
    overflow-y: auto;      

    width: 80%;
    max-width: 1000px;
    min-height: 220px;   
    height: auto;        
    overflow: hidden; 

    background: rgba(255,255,255,0.55);
    backdrop-filter: blur(18px);

    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);

    padding: 35px 25px 25px 25px;
    box-sizing: border-box;

    z-index: 5;
}

#nameTag {
    position: absolute;
    top: 10px;
    left: 30px;

    background: #2c4e80;
    color: white;

    padding: 6px 18px;
    border-radius: 12px;

    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

#patientResponse {
    font-size: 20px;
    margin-top: 20px;
    margin-bottom: 20px;
    color: #222;
}

/* ì…ë ¥ */
input {
    width: 500px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
}

button {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    background-color: #2c4e80;
    color: white;
    cursor: pointer;
    font-size: 14px;
}

button:hover {
    background-color: #1f3760;
}

</style>
</head>

<body>

<div id="statusPanel">
    <h2>í™˜ì ìƒíƒœ</h2>

    ë¶ˆì•ˆ <span id="anxietyValue">{{ patient_state.anxiety }}</span>
    <div class="bar" id="anxietyBar"></div>

    ê³µê²©ì„± <span id="aggressionValue">{{ patient_state.aggression }}</span>
    <div class="bar" id="aggressionBar"></div>

    ì§€ë‚¨ë ¥ <span id="orientationValue">{{ patient_state.orientation }}</span>
    <div class="bar" id="orientationBar"></div>

    <h2>ê°„í˜¸ì‚¬ ëŠ¥ë ¥</h2>

    ê³µê° <span id="empathyValue">{{ nurse_state.empathy }}</span>
    <div class="bar" id="empathyBar"></div>

    ë¬¸ì œí•´ê²° <span id="problemValue">{{ nurse_state.problem_solving }}</span>
    <div class="bar" id="problemBar"></div>
</div>

<div id="groundShadow"></div>

<img id="patientImage" src="{{ url_for('static', filename='image/stable.png') }}">



<div id="dialogueBox">
    <div id="nameTag">ê¹€ì² ìˆ˜(78ì„¸)</div>
    <div id="hintBox" style="
        margin-top:10px;
        font-size:14px;
        color:#333;
        background:rgba(255,255,255,0.35);
        padding:8px 12px;
        border-radius:10px;
    ">
    ğŸ’¡ {{ hint }}
    </div>

    <div id="patientResponse">ì—¬ê¸°ê°€ ì–´ë””ìš”â€¦?</div>
    <div id="loadingText" style="display:none; color:#000000; font-size:14px;">
    ë‹µë³€ ìƒì„±ì¤‘...
    </div> <!-- ğŸ”¥ ì¶”ê°€ -->

    <div>
        <input type="text" id="nurseInput">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<script>

function typeWriter(text, speed = 35) {  // ğŸ”¥ ì¶”ê°€
    const element = document.getElementById("patientResponse");
    element.innerText = "";
    let i = 0;

    function typing() {
        if (i < text.length) {
            element.innerText += text.charAt(i);
            i++;
            setTimeout(typing, speed);
        }
    }

    typing();
}

function updateBar(id, value) {
    const bar = document.getElementById(id);
    bar.style.width = value + "%";

    if (value > 70) bar.style.background = "#e74c3c";
    else if (value > 40) bar.style.background = "#f39c12";
    else bar.style.background = "#2ecc71";

    const valueId = id.replace("Bar", "Value");
    const valueElement = document.getElementById(valueId);
    if (valueElement) {
        valueElement.innerText = Math.round(value);
    }
}

function updateImage(aggression) {
    const img = document.getElementById("patientImage");

    if (aggression >= 70) {
        img.src = "/static/image/angry.png";
    } else {
        img.src = "/static/image/stable.png";
    }
}

function sendMessage() {

    const inputField = document.getElementById("nurseInput"); // ğŸ”¥ ì¶”ê°€
    const input = inputField.value;

    if (!input.trim()) return; // ğŸ”¥ ì¶”ê°€

    inputField.disabled = true; // ğŸ”¥ ì¶”ê°€

    document.getElementById("patientResponse").innerText = ""; // ğŸ”¥ ì¶”ê°€
    document.getElementById("loadingText").style.display = "block"; // ğŸ”¥ ì¶”ê°€

    fetch("/interact", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ nurse_input: input })
    })
    .then(res => res.json())
    .then(data => {

        document.getElementById("loadingText").style.display = "none"; // ğŸ”¥ ì¶”ê°€
        
        typeWriter(data.patient_response); // ğŸ”¥ ì¶”ê°€
        document.getElementById("hintBox").innerText = "ğŸ’¡ " + data.hint;

        updateBar("anxietyBar", data.patient_state.anxiety);
        updateBar("aggressionBar", data.patient_state.aggression);
        updateBar("orientationBar", data.patient_state.orientation);

        updateBar("empathyBar", data.nurse_state.empathy);
        updateBar("problemBar", data.nurse_state.problem_solving);

        updateImage(data.patient_state.aggression);

        inputField.disabled = false; // ğŸ”¥ ì¶”ê°€
        inputField.value = ""; // ğŸ”¥ ì¶”ê°€
    })
    .catch(err => { // ğŸ”¥ ì¶”ê°€
        document.getElementById("loadingText").innerText = "ì˜¤ë¥˜ ë°œìƒ";
        inputField.disabled = false;
    });
}

window.addEventListener("DOMContentLoaded", function() {

    updateBar("anxietyBar", {{ patient_state.anxiety }});
    updateBar("aggressionBar", {{ patient_state.aggression }});
    updateBar("orientationBar", {{ patient_state.orientation }});

    updateBar("empathyBar", {{ nurse_state.empathy }});
    updateBar("problemBar", {{ nurse_state.problem_solving }});

});

</script>

</body>
</html>
